{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-09-06-ssl-with-grpc/","result":{"data":{"site":{"siteMetadata":{"title":"LAP-TECH"}},"markdownRemark":{"id":"ca196c0e-da25-5e11-af4e-e9b664151e7a","excerpt":"近來工作上用到  需要起一隻  夾  做  搞到頭都大先整得好 特此記錄一下 NGINX Setup 以下會用上  做例子  底層其實係  來 而  本來就係  以常理黎講應該就可以直接用  既方式去做  正當我滿心歡喜SET好晒啲野諗著淡淡定有錢剩既時候，一用個  隊埋去就出句咁既野 仆街喇點解唔得架呢 Check…","html":"<p>近來工作上用到 <code class=\"language-text\">gRPC</code> 需要起一隻 <code class=\"language-text\">gRPC Server</code> 夾 <code class=\"language-text\">NGINX</code> 做 <code class=\"language-text\">LOAD BALANCING</code> 搞到頭都大先整得好 特此記錄一下</p>\n<h2>NGINX Setup</h2>\n<p>以下會用上 <code class=\"language-text\">Docker + NGINX 1.21.0, gRPC port = 12345</code> 做例子</p>\n<p><code class=\"language-text\">gRPC</code> 底層其實係 <code class=\"language-text\">HTTP/2</code> 來 而 <code class=\"language-text\">HTTP/2</code> 本來就係 <code class=\"language-text\">TCP</code> 以常理黎講應該就可以直接用 <code class=\"language-text\">TCP SSL STREAM</code> 既方式去做 <code class=\"language-text\">REDIRECT</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">stream {\n    server {\n        listen               12345 ssl;\n        ssl_certificate      ${SSL_CERT};\n        ssl_certificate_key  ${SSL_KEY};\n        ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;\n        proxy_pass           ${UPSTREAM}:12345;\n    }\n}</code></pre></div>\n<p>正當我滿心歡喜SET好晒啲野諗著淡淡定有錢剩既時候，一用個 <code class=\"language-text\">BloomRPC</code> 隊埋去就出句咁既野</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\">&quot;error&quot;: &quot;14 UNAVAILABLE: failed to connect to all addresses&quot;</code></pre></div>\n<p>仆街喇點解唔得架呢</p>\n<p>Check埋 <code class=\"language-text\">NGINX</code> 都係唔WORK，搵左一輪發現原來唔可以咁寫個 <code class=\"language-text\">nginx.config</code> 相信係同 <code class=\"language-text\">HTTP/2 TCP multiplexing</code> 有關。而想係 <code class=\"language-text\">NGINX</code> 入面做 <code class=\"language-text\">gRPC</code> PORT FORWARDING 我地既 config 要咁寫。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http {\n    server {\n        listen               12345 ssl http2;\n        ssl_certificate      ${SSL_CERT};\n        ssl_certificate_key  ${SSL_KEY};\n        location / {\n            grpc_pass        ${UPSTREAM}:12345;\n        }\n    }\n}</code></pre></div>\n<p>再用 <code class=\"language-text\">BloomRPC</code> 隊多次埋去，失敗。係呢個時候都係要睇埋 NGINX 既LOG</p>\n<div class=\"gatsby-highlight\" data-language=\"log\"><pre class=\"language-log\"><code class=\"language-log\">client node disconnected</code></pre></div>\n<p>即係駁到埋去但係比人彈番轉頭\n之後再搵下點解 原來 gRPC 既 call 係 TLS 之下冇得就咁用 Server Authentication, 需要入番張 Cert 落去先得</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9e8ba4727280e41baccb7d162b782901/1fbe8/ssl.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABZ0lEQVQoz42OTUtCURCGT0G062uXRhCWURhEUYtQyqBa9Ef6FRplH+qiFm0KonX/oE07LUqNgqCFIIl3EVnavd6P4zn3zHSOt8Da1PAwvDPnnZlDhsenA6G5yZmFqfnIYCDU4xvt849Jen1feKVHvz/oMTAUHJmYJWQ5QVb3Otf2u9bTHdEtEo6RSJwsxkg0RpZaWepIG2GPePfKJknmcPcaE1nczmDqFpM3uHOFhwU8fcTjBzy5x6M7TOUw/Ys8JrOUIDaR1tF6A7OKSIHpYLxAU0dkyE3XeHWprjxIf8KYXSMC0abMcpqmTZvcdQFlRwByAS4AKA1KC2wDpKduNORl5JwzxmSWWvpd1xVCjoCnZU9udJhwuIJycLjabjQaRD5Q6lBKW2fkb5jVCjkm10kBQtgMqrr9btjVD7NuUocrp2nq6vL/Q6gpKNbwII+ZkkU0Tav8Fdo3z+VypVS8KJQ3zrWzy6dPqXmePp1Jg6wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"BloomRPC Cert Mapping\"\n        title=\"BloomRPC Cert Mapping\"\n        src=\"/static/9e8ba4727280e41baccb7d162b782901/fcda8/ssl.png\"\n        srcset=\"/static/9e8ba4727280e41baccb7d162b782901/12f09/ssl.png 148w,\n/static/9e8ba4727280e41baccb7d162b782901/e4a3f/ssl.png 295w,\n/static/9e8ba4727280e41baccb7d162b782901/fcda8/ssl.png 590w,\n/static/9e8ba4727280e41baccb7d162b782901/1fbe8/ssl.png 757w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>最緊要係要入番個 CA 落去 (圖中既 altmanwong.github.io, 張張 cert 都唔同) 唔係call多10次都係會call唔到</p>\n<h2>Client side</h2>\n<p>Client Side 會用 <code class=\"language-text\">C#</code> + <code class=\"language-text\">gRPC.Core</code> 做例子</p>\n<p>本來打算就咁寫就算</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Channel</span> <span class=\"token function\">GetChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Channel</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetServiceUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ChannelCredential<span class=\"token punctuation\">.</span>SecureSsl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>見到咁簡單，以為輕輕鬆鬆又過到關。點知起機一試吉埋隻 <code class=\"language-text\">NGINX</code> 到又係爆炸冇反應。</p>\n<p>如果用番 <code class=\"language-text\">BloomRPC</code> 嘅 config 去睇，我地上面段CODE冇左幾樣野:</p>\n<ol>\n<li>Server Cert</li>\n<li>SSL Name (又稱CN)</li>\n</ol>\n<p>問題就黎喇，我嘅 Client Side 根本就唔會有 Server Cert 係到。咁點做 Authentication 呢？</p>\n<h2>偷CERT</h2>\n<p>係張 Cert 唔係 Client side 既情況之下唯有用到 <code class=\"language-text\">HTTP</code> 既方法拎張 Cert 落黎，再放番入去 <code class=\"language-text\">gRPC Channel</code> 入面做 <code class=\"language-text\">Verification</code></p>\n<p>首先要做一個 HttpWebRequest 行埋去 Server</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">try</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">HttpWebRequest</span> request <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HttpWebRequest<span class=\"token punctuation\">)</span>WebRequest<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://{0}\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetServiceUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    request<span class=\"token punctuation\">.</span>ServerCertificateValidationCallback <span class=\"token operator\">=</span> ServerCertificateValidationCallbackHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">HttpWebResponse</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>HttpWebResponse<span class=\"token punctuation\">)</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">GetResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Ignore exception since we do not care about the response</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然後係 <code class=\"language-text\">ServerCertificateValidationCallbackHandler</code> 到接番張 Cert, 再 Load 番佢入去條 <code class=\"language-text\">Channel</code></p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> <span class=\"token function\">ServerCertificateValidationCallbackHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> sender<span class=\"token punctuation\">,</span> <span class=\"token class-name\">X509Certificate</span> certificate<span class=\"token punctuation\">,</span> <span class=\"token class-name\">X509Chain</span> chain<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SslPolicyErrors</span> sslPolicyErrors<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    SslCredential <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SslCredentials</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetPEMCert</span><span class=\"token punctuation\">(</span>certificate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ChannelOptionList<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ChannelOption</span><span class=\"token punctuation\">(</span>ChannelOptions<span class=\"token punctuation\">.</span>SslTargetNameOverride<span class=\"token punctuation\">,</span> <span class=\"token function\">GetCnFromSubject</span><span class=\"token punctuation\">(</span>certificate<span class=\"token punctuation\">.</span>Subject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sslPolicyErrors <span class=\"token operator\">==</span> SslPolicyErrors<span class=\"token punctuation\">.</span>None<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetCnFromSubject</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> subject<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Regex</span> cnRegex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Regex</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CN=(.*?),\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> cnRegex<span class=\"token punctuation\">.</span><span class=\"token function\">Match</span><span class=\"token punctuation\">(</span>subject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>Length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>Groups<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>Groups<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Length <span class=\"token operator\">-</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">else</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> subject<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetPEMCert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">X509Certificate</span> cert<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">StringBuilder</span> builder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StringBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    builder<span class=\"token punctuation\">.</span><span class=\"token function\">AppendLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-----BEGIN CERTIFICATE-----\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    builder<span class=\"token punctuation\">.</span><span class=\"token function\">AppendLine</span><span class=\"token punctuation\">(</span>Convert<span class=\"token punctuation\">.</span><span class=\"token function\">ToBase64String</span><span class=\"token punctuation\">(</span>cert<span class=\"token punctuation\">.</span><span class=\"token function\">Export</span><span class=\"token punctuation\">(</span>X509ContentType<span class=\"token punctuation\">.</span>Cert<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Base64FormattingOptions<span class=\"token punctuation\">.</span>InsertLineBreaks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    builder<span class=\"token punctuation\">.</span><span class=\"token function\">AppendLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-----END CERTIFICATE-----\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>著機吉埋去，BOOOOOOOOOOOOOOOOOOOOOOOM 有野睇了。</p>","frontmatter":{"title":"gRPC SSL 全記錄","date":"September 06, 2021"}}},"pageContext":{"slug":"/2021-09-06-ssl-with-grpc/","previous":{"fields":{"slug":"/2021-03-16-wpf-datagrid-header-binding/"},"frontmatter":{"title":"WPF DataGrid Header Binding"}},"next":null}}}